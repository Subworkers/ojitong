# common
PYTHON_VERSION=py311
RELEASE_VERSION=v0.1.0
AWS_ECR_REPO_ENDPOINT_URL=public.ecr.aws/v5d5z1j6/subworkers/ojitong

# dev image
ADDITIONAL_COMPONENTS=jupyter
DEV_SERVICE=dev
DEV_CONTAINER_NAME=$(DEV_SERVICE***REMOVED***-$(PYTHON_VERSION***REMOVED***-$(ADDITIONAL_COMPONENTS***REMOVED***

IMAGE_NAME=$(AWS_ECR_REPO_ENDPOINT_URL***REMOVED***/$(DEV_SERVICE***REMOVED***
IMAGE_TAG=$(RELEASE_VERSION***REMOVED***-$(PYTHON_VERSION***REMOVED***-$(ADDITIONAL_COMPONENTS***REMOVED***

DOCKERFILE_PATH=$(PWD***REMOVED***/$(PYTHON_VERSION***REMOVED***-$(ADDITIONAL_COMPONENTS***REMOVED***.Dockerfile
DOCKERCOMPOSE_FILE_PATH=$(PWD***REMOVED***/docker-compose-$(DEV_SERVICE***REMOVED***.yaml

JUPYTER_NB_PORT=10000

ENV_PREFIX=IMAGE_NAME=$(IMAGE_NAME***REMOVED*** IMAGE_TAG=$(IMAGE_TAG***REMOVED*** DOCKERFILE_PATH=$(DOCKERFILE_PATH***REMOVED*** JUPYTER_NB_PORT=$(JUPYTER_NB_PORT***REMOVED***

# base runner image
RUNNER_RELEASE_VERSION=v0.1.0
RUNNER_SERVICE=runner
RUNNER_BASE_SERVICE=base
RUNNER_BASE_CONTAINER_NAME=$(RUNNER_SERVICE***REMOVED***-$(RUNNER_BASE_SERVICE***REMOVED***

RUNNER_BASE_IMAGE_NAME=$(AWS_ECR_REPO_ENDPOINT_URL***REMOVED***/$(RUNNER_SERVICE***REMOVED***/$(RUNNER_BASE_SERVICE***REMOVED***
RUNNER_BASE_IMAGE_TAG=$(RELEASE_VERSION***REMOVED***-$(PYTHON_VERSION***REMOVED***

RUNNER_BASE_DOCKERFILE_PATH=$(PWD***REMOVED***/$(PYTHON_VERSION***REMOVED***-$(RUNNER_BASE_CONTAINER_NAME***REMOVED***.Dockerfile
RUNNER_BASE_DOCKERCOMPOSE_FILE_PATH=$(PWD***REMOVED***/docker-compose-$(RUNNER_SERVICE***REMOVED***.yaml

# common runner config
RUNNER_DOCKER_GROUP_NAME=docker
RUNNER_DOCKER_GROUP_ID=234
RUNNER_ENV_PREFIX=DOCKER_BUILDKIT=1 BASE_IMAGE_NAME=$(RUNNER_BASE_IMAGE_NAME***REMOVED*** BASE_IMAGE_TAG=$(RUNNER_BASE_IMAGE_TAG***REMOVED*** TEST_IMAGE_NAME=$(RUNNER_TEST_IMAGE_NAME***REMOVED*** TEST_IMAGE_TAG=$(RUNNER_TEST_IMAGE_TAG***REMOVED*** DOCKER_GROUP_NAME=$(RUNNER_DOCKER_GROUP_NAME***REMOVED*** DOCKER_GROUP_ID=$(RUNNER_DOCKER_GROUP_ID***REMOVED***

# make build.dev
build.dev:
	$(ENV_PREFIX***REMOVED*** docker-compose -f $(DOCKERCOMPOSE_FILE_PATH***REMOVED*** build $(DEV_CONTAINER_NAME***REMOVED***

# make build.runner
build.runner:
	$(RUNNER_ENV_PREFIX***REMOVED*** docker-compose -f $(RUNNER_BASE_DOCKERCOMPOSE_FILE_PATH***REMOVED*** build $(RUNNER_BASE_CONTAINER_NAME***REMOVED***

# make build.dev
pull.dev:
	docker pull $(IMAGE_NAME***REMOVED***:$(IMAGE_TAG***REMOVED***

# make build.dev
push.dev:
	docker tag $(IMAGE_NAME***REMOVED***:$(IMAGE_TAG***REMOVED*** $(IMAGE_NAME***REMOVED***:$(IMAGE_TAG***REMOVED***
	docker push $(IMAGE_NAME***REMOVED***:$(IMAGE_TAG***REMOVED***
	
	docker tag $(IMAGE_NAME***REMOVED***:$(IMAGE_TAG***REMOVED*** $(IMAGE_NAME***REMOVED***:latest
	docker push $(IMAGE_NAME***REMOVED***:latest

# make pull.runner
pull.runner:
	docker pull $(RUNNER_BASE_IMAGE_NAME***REMOVED***:$(RUNNER_BASE_IMAGE_TAG***REMOVED***

# make push.runner.base
push.runner.base:
	docker tag $(RUNNER_BASE_IMAGE_NAME***REMOVED***:$(RUNNER_BASE_IMAGE_TAG***REMOVED*** $(RUNNER_BASE_IMAGE_NAME***REMOVED***:$(RUNNER_BASE_IMAGE_TAG***REMOVED***
	docker push $(RUNNER_BASE_IMAGE_NAME***REMOVED***:$(RUNNER_BASE_IMAGE_TAG***REMOVED***
	
	docker tag $(RUNNER_BASE_IMAGE_NAME***REMOVED***:$(RUNNER_BASE_IMAGE_TAG***REMOVED*** $(RUNNER_BASE_IMAGE_NAME***REMOVED***:latest
	docker push $(RUNNER_BASE_IMAGE_NAME***REMOVED***:latest

# make start
start:
	$(ENV_PREFIX***REMOVED*** docker-compose -f $(DOCKERCOMPOSE_FILE_PATH***REMOVED*** up $(DEV_CONTAINER_NAME***REMOVED*** -d
	$(RUNNER_ENV_PREFIX***REMOVED*** docker-compose -f $(RUNNER_BASE_DOCKERCOMPOSE_FILE_PATH***REMOVED*** up $(RUNNER_BASE_CONTAINER_NAME***REMOVED*** -d
	
# make down
down:
	$(ENV_PREFIX***REMOVED*** docker-compose -f $(DOCKERCOMPOSE_FILE_PATH***REMOVED*** down --remove-orphans
	$(RUNNER_ENV_PREFIX***REMOVED*** docker-compose -f $(RUNNER_BASE_DOCKERCOMPOSE_FILE_PATH***REMOVED*** down 
